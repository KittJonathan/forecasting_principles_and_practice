---
title: "2. Time series graphics"
format: html
editor: visual
execute: 
  echo: true
  eval: true
---

<https://otexts.com/fpp3/graphics.html>

# 2.1 `tsibble` objects

```{r}
library(fpp3)
```

```{r}
global_economy
```

```{r}
tourism
```

A `tsibble` contains:

-   an index: time observation about the observation

-   measured variable(s): numbers of interest

-   key variable(s): optional unique identifiers for each series

To create a `tsibble`:

```{r}
mydata <- tsibble(
  year = 2015:2019,
  y = c(123, 39, 78, 52, 110),
  index = year
)
mydata
```

Transform an object into a `tsibble`:

```{r}
mydata <- tibble(
  year = 2015:2019,
  y = c(123, 39, 78, 52, 110)
) |> 
  as_tsibble(index = year)
mydata
```

For observations more frequent than once per year, we need to use a time class function on the index.

```{r}
z <- tibble(
  Month = c("2019 Jan", "2019 Feb", "2019 Mar", "2019 Apr"),
  Observation = c(50, 23, 34, 30)
)
z
```

```{r}
z |> 
  mutate(Month = yearmonth(Month)) |> 
  as_tsibble(index = Month)
```

Common time index variables can be created with these functions:

| Frequency | Function                     |
|-----------|------------------------------|
| Annual    | `start:end`                  |
| Quarterly | `yearquarter()`              |
| Monthly   | `yearmonth()`                |
| Weekly    | `yearweek()`                 |
| Daily     | `as_date()`, `ymd()`         |
| Sub-daily | `as_datetime()`, `ymd_hms()` |

```{r}
prison <- readr::read_csv(
  "https://OTexts.com/fpp3/extrafiles/prison_population.csv")
```

```{r}
prison
```

```{r}
prison |> 
  mutate(Quarter = yearquarter(Date)) |> 
  select(-Date) |> 
  as_tsibble(
    index = Quarter,
    key = c(State, Gender, Legal, Indigenous)
  )
```

```{r}
olympic_running
```

```{r}
olympic_running |> 
  distinct(Sex)
```

```{r}
PBS
```

```{r}
a10 <- PBS |> 
  filter(ATC2 == "A10") |> 
  select(Month, Concession, Type, Cost) |> 
  summarise(TotalC = sum(Cost)) |> 
  mutate(Cost = TotalC / 1e6)
a10
```

The seasonal period:

| Data     | Minute | Hour | Day   | Week   | Year     |
|----------|--------|------|-------|--------|----------|
| Quarters |        |      |       |        | 4        |
| Months   |        |      |       |        | 12       |
| Weeks    |        |      |       |        | 52       |
| Days     |        |      |       | 7      | 365.25   |
| Hours    |        |      | 24    | 168    | 8766     |
| Minutes  |        | 60   | 1440  | 10080  | 525960   |
| Seconds  | 60     | 3600 | 86400 | 604800 | 31557600 |

# 2.2 Time plots

```{r}
a10 |> 
  autoplot(Cost) |> 
  labs(y = "$ (millions)",
       title = "Australian antidiabetic drug saled")
```

```{r}
a10 |> 
  ggplot(aes(x = Month, y = Cost)) +
  geom_point()
```

```{r}
a10 |> 
  ggplot(aes(x = Month, y = Cost)) +
  geom_line()
```

```{r}
a10 |> 
  autoplot(Cost) +
  geom_point()
```

```{r}
a10 |> 
  autoplot(Cost) +
  labs(title = "Antidiabetic drug sales",
       y = "$ million")
```

```{r}
ansett |> 
  autoplot(Passengers)
```

```{r}
ansett |> distinct(Class)
```

```{r}
ansett |> distinct(Airports)
```

```{r}
ansett |> 
  filter(Class == "Economy", Airports == "MEL-SYD") |> 
  mutate(Passengers = Passengers / 1000) |> 
  autoplot(Passengers) +
  labs(title = "Ansett airlines economy class",
       subtitle = "Melbourne-Sydney",
       y = "Passengers ('000)")
```

# 2.3 Time series patterns

<https://otexts.com/fpp3/tspatterns.html>

**Trend**: pattern exists when there is a long-term increase or decrease in the data.

**Seasonal**: pattern exists when a series is influenced by seasonal factors (e.g. the quarter of the year, the month, or day of the week).

**Cyclic**: pattern exists when data exhibit rises and falls that are *not of fixed period* (duration usually of at least 2 years).

Differences between seasonal and cyclic patterns:

-   seasonal pattern constant length; cyclic pattern variable length

-   average length of cycle longer than length of seasonal pattern

-   magnitude of cycle more variable than magnitude of seasonal pattern

```{r}
aus_production |> 
  filter(year(Quarter) >= 1980) |> 
  autoplot(Electricity) +
  labs(y = "GWh", title = "Australian electricity production")
```

```{r}
aus_production |> 
  autoplot(Bricks) +
  labs(y = "million units", title = "Australian clay brick production")
```

```{r}
us_employment |> 
  filter(Title == "Retail Trade", year(Month) >= 1980) |> 
  autoplot(Employed / 1e3) +
  labs(y = "Million people", title = "Retail employment, USA")
```

```{r}
gafa_stock |> 
  filter(Symbol == "AMZN", year(Date) >= 2018) |> 
  autoplot(Close) +
  labs(y = "$US", title = "Amazon closing stock price")
```

```{r}
pelt |> 
  autoplot(Lynx) +
  labs(y = "Number trapped", title = "Annual Canadian Lynx Trappings")
```

> The timing of peaks and troughs is predictable with seasonal data, but unpredictable in the long term with cyclic data.

# 2.4 Seasonal plots

```{r}
a10 |> 
  autoplot(Cost)
```

```{r}
a10 |> 
  gg_season(Cost, labels = "both") + 
  labs(y = "$ million", title = "Seasonal plot: antidiabetic drug sales")
```

Seasonal plot:

-   Data plotted against the individual "seasons" in which the data were observed (in this case a "season" is a month)

-   Something like a time plot except that the data from each season are overlapped

-   Enables the underlying seasonal pattern to be seen more clearly, and also allows any substantial departures from the seasonal pattern to be easily identified

-   In R: `gg_season()`

```{r}
beer <- aus_production |> 
  select(Quarter, Beer) |> 
  filter(year(Quarter) >= 1992)
```

```{r}
beer |> 
  autoplot(Beer) +
  labs(title = "Australian beer production", y = "Megalitres")
```

```{r}
beer |> 
  autoplot(Beer) +
  geom_point() +
  labs(title = "Australian beer production", y = "Megalitres")
```

```{r}
beer |> 
  gg_season(Beer, labels = "right")
```

```{r}
# Victoria electricity data (observed every 30min)
vic_elec
```

```{r}
vic_elec |> 
  autoplot()
```

```{r}
vic_elec |> 
  gg_season(Demand)
```

```{r}
vic_elec |> 
  gg_season(Demand, period = "week")
```

```{r}
vic_elec |> 
  gg_season(Demand, period = "day")
```

# 2.5 Seasonal subseries plots

```{r}
a10 |> 
  autoplot(Cost) +
  labs(y = "$ (millions)", title = "Australian antidiabetic drug sales")
```

```{r}
a10 |> 
  gg_subseries(Cost) +
  labs(y = "$ million", title = "Subseries plot: antidiabetic drug sales")
```

-   Data for each season collected together in time plot as separate time series

-   Enables the underlying seasonal pattern to be seen clearly, and changes in seasonality over time to be visualized

-   In R: `gg_subseries()`

```{r}
beer |> 
  autoplot(Beer)
```

```{r}
beer |> 
  gg_subseries(Beer)
```

```{r}
holidays <- tourism |> 
  filter(Purpose == "Holiday") |> 
  group_by(State) |> 
  summarise(Trips = sum(Trips))
holidays
```

```{r}
holidays |> 
  autoplot(Trips) +
  labs(y = "thousands of trips",
       title = "Australian domestic holiday nights")
```

```{r}
holidays |> 
  gg_season(Trips) +
  facet_wrap(vars(State), nrow = 2, scales = "free_y") +
  labs(y = "Thousands od trips",
       title = "Australian domestic holiday nights")
```

```{r}
holidays |> 
  gg_subseries(Trips) +
  labs(y = "Thousands of trips",
       title = "Australian domestic holiday nights")
```

# 2.6 Scatterplots

```{r}
vic_elec_day_type <- vic_elec |> 
  filter(year(Time) == 2014) |> 
  mutate(
    Day_Type = case_when(
      Holiday ~ "Holiday",
      wday(Date) %in% 2:6 ~ "Weekday",
      TRUE ~ "Weekend"))
vic_elec_day_type
```

```{r}
vic_elec_day_type |> 
  autoplot(Demand) +
  labs(y = "GW")
```

```{r}
vic_elec_day_type |> 
  autoplot(Temperature) +
  labs(y = "Degrees Celsius")
```

```{r}
vic_elec_day_type |> 
  ggplot(aes(x = Temperature, y = Demand)) +
  geom_point() +
  labs(x = "Temperature (degrees Celsius",
       y = "Electricity demand (GW)")
```

```{r}
vic_elec_day_type |> 
  ggplot(aes(x = Temperature, y = Demand, colour = Day_Type)) +
  geom_point() +
  labs(x = "Temperature (degrees Celsius",
       y = "Electricity demand (GW)")
```

```{r}
vic_elec |> 
  filter(year(Time) == 2014) |> 
  autoplot(Temperature) +
  labs(
    y = "Degrees Celsius",
    title = "Half-hourly temperatures: Melbourne, Australia"
  )
```

The correlation coefficient measures the extent of a linear relationship between two variables (lies between -1 and 1).

```{r}
us_change |> 
  GGally::ggpairs(columns = 2:6)
```

```{r}
tourism |> 
  group_by(State) |> 
  summarise(Trips = sum(Trips)) |> 
  ggplot(aes(x = Quarter, y = Trips)) +
  geom_line() +
  facet_grid(vars(State), scales = "free_y") +
  labs(title = "Australian domestic tourism",
       y = "Overnight trips ('000)")
```

# 2.7 Lag plots
